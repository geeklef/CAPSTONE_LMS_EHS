<?php
include '../../config/db_connect.php';
session_start();

$teacher_id = $_SESSION['teacher_id'] ?? 1;
$strand = $_GET['strand'] ?? ($_SESSION['strand'] ?? '');
$section = $_GET['section'] ?? ($_SESSION['section'] ?? '');
$course_name = $_GET['course'] ?? ($_SESSION['course'] ?? '');

if (!empty($strand)) $_SESSION['strand'] = $strand;
if (!empty($section)) $_SESSION['section'] = $section;
if (!empty($course_name)) $_SESSION['course'] = $course_name;

// Fetch teacher's full name
$prof_name = 'DefaultProf';
$teacher_name = 'Unknown Teacher';

$stmt = $conn->prepare("SELECT first_name, last_name FROM teachers_account WHERE teacher_id = :teacher_id");
$stmt->execute(['teacher_id' => $teacher_id]);
if ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
    $teacher_name = $row['first_name'] . ' ' . $row['last_name'];
    $prof_name = preg_replace('/\s+/', '', $row['first_name'] . $row['last_name']);
}

$class_id = '';
if (!empty($strand) && !empty($section)) {
    $stmt = $conn->prepare("SELECT class_id FROM prof_courses WHERE teacher_id = :teacher_id AND strand = :strand AND section = :section LIMIT 1");
    $stmt->execute(['teacher_id' => $teacher_id, 'strand' => $strand, 'section' => $section]);
    if ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
        $class_id = $row['class_id'];
    }
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (isset($_POST['add_activity'])) {
        $title = $_POST['title'] ?? '';
        $desc = $_POST['desc'] ?? '';
        $due_date = $_POST['due_date'] ?? '';
        $due_time = $_POST['due_time'] ?? '';
        $date_posted = date('Y-m-d');

        $fileName = null;
        $filePath = null;

        if (isset($_FILES['file']) && $_FILES['file']['error'] === 0) {
            $fileTmp = $_FILES['file']['tmp_name'];
            $fileName = basename($_FILES['file']['name']);

            $baseDir = __DIR__ . '/../../uploads/' . $prof_name . '/' . $strand . '-' . $section . '/assignment/';
            if (!is_dir($baseDir)) {
                mkdir($baseDir, 0777, true);
            }

            $filePath = $baseDir . $fileName;
            move_uploaded_file($fileTmp, $filePath);

            // âœ… Save relative path for browser access
            $fileUrl = '../../uploads/' . $prof_name . '/' . $strand . '-' . $section . '/assignment/' . $fileName;
        } else {
            $fileUrl = null;
        }


        $sql = "INSERT INTO prof_activities 
        (teacher_id, class_id, section, title, date_posted, due_date, due_time, \"desc\", file_name, file_path)
        VALUES (:teacher_id, :class_id, :section, :title, :date_posted, :due_date, :due_time, :desc, :file_name, :file_path)";

        $stmt = $conn->prepare($sql);
        $stmt->execute([
            'teacher_id' => $teacher_id,
            'class_id' => $class_id,
            'section' => $section,
            'title' => $title,
            'date_posted' => $date_posted,
            'due_date' => $due_date,
            'due_time' => $due_time,
            'desc' => $desc,
            'file_name' => $fileName,
            'file_path' => $fileUrl 
        ]);

        header("Location: " . $_SERVER['REQUEST_URI']);
        exit();
    }
}

if (isset($_GET['delete_id'])) {
    $delete_id = intval($_GET['delete_id']);

    $stmt = $conn->prepare("SELECT file_path FROM prof_activities WHERE activity_id = :id");
    $stmt->execute(['id' => $delete_id]);
    $row = $stmt->fetch(PDO::FETCH_ASSOC);
    if ($row && file_exists($row['file_path'])) {
        unlink($row['file_path']);
    }

    $stmt = $conn->prepare("DELETE FROM prof_activities WHERE activity_id = :id");
    $stmt->execute(['id' => $delete_id]);

    header("Location: " . strtok($_SERVER["REQUEST_URI"], '?'));
    exit();
}

// Fetch activities (latest first)
$activities = [];
$sqlFetch = "SELECT * FROM prof_activities WHERE teacher_id = :teacher_id AND class_id = :class_id AND section = :section ORDER BY activity_id DESC";
$stmtFetch = $conn->prepare($sqlFetch);
$stmtFetch->execute(['teacher_id' => $teacher_id, 'class_id' => $class_id, 'section' => $section]);
$activities = $stmtFetch->fetchAll(PDO::FETCH_ASSOC);

// Edit Activity
if (isset($_POST['edit_activity_id'])) {
    $edit_id = intval($_POST['edit_activity_id']);
    $edit_title = $_POST['edit_title'];
    $edit_due_date = $_POST['edit_due_date'];
    $edit_due_time = $_POST['edit_due_time'];
    $edit_desc = $_POST['edit_desc'];

    $stmt = $conn->prepare("UPDATE prof_activities 
        SET title = :title, due_date = :due_date, due_time = :due_time, \"desc\" = :desc 
        WHERE activity_id = :id");
    $stmt->execute([
        'title' => $edit_title,
        'due_date' => $edit_due_date,
        'due_time' => $edit_due_time,
        'desc' => $edit_desc,
        'id' => $edit_id
    ]);

    header("Location: " . $_SERVER['REQUEST_URI']);
    exit();
}

// Fetch activities again for display
$activities = [];
$sqlFetch = "SELECT * FROM prof_activities WHERE teacher_id = :teacher_id AND class_id = :class_id AND section = :section";
$stmtFetch = $conn->prepare($sqlFetch);
$stmtFetch->execute(['teacher_id' => $teacher_id, 'class_id' => $class_id, 'section' => $section]);
$activities = $stmtFetch->fetchAll(PDO::FETCH_ASSOC);
?>






<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LMS Dashboard</title>

  <!-- Google Fonts and Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Quicksand", sans-serif;
    }

    body {
      display: flex;
      height: 100vh;
      background-color: #f4f7f9;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 250px;
      background-color: #004aad;
      color: white;
      padding: 20px;
      overflow-y: auto;
    }

    .sidebar h2 {
      margin-bottom: 10px;
    }

    .sidebar h3 {
      margin-left: 40px;
      margin-bottom: 40px;
    }

    .sidebar .menu a {
      display: block;
      padding: 10px 0;
      color: white;
      text-decoration: none;
      margin-bottom: 10px;
    }

    .sidebar .menu a:hover {
      background-color: #004aad;
      padding-left: 10px;
    }

    .main {
      margin-left: 250px;
      flex: 1;
      padding: 20px;
    }

    .topbar {
      background-color: #004aad;
      padding: 20px;
      color: white;
      font-size: 24px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .back-btn {
      display: inline-block;
      text-decoration: none;
      margin-right: 10px;
      color: white;
    }

    .back-btn .material-icons {
      font-size: 28px;
      vertical-align: middle;
    }

    .rewards {
      position: relative;
      display: flex;
      flex-direction: column;
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .btn {
      background-color: white;
      color: #004aad;
      padding: 8px 15px;
      border: 2px solid #004aad;
      border-radius: 40px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      margin-bottom: 10px;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .btn:hover {
      background-color: #003b8c;
      color: white;
    }

    .menu-dots {
      position: absolute;
      top: 15px;
      right: 15px;
      cursor: pointer;
      color: #555;
    }

    .menu-dots:hover {
      color: #000;
    }

    .dropdown-menu {
      display: none;
      position: absolute;
      top: 35px;
      right: 15px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      z-index: 999;
      min-width: 150px;
    }

    .dropdown-menu a {
      display: block;
      padding: 10px 15px;
      color: #333;
      text-decoration: none;
      font-size: 14px;
    }

    .dropdown-menu a:hover {
      background-color: #f2f2f2;
    }

    .file-overview {
      margin-top: 15px;
      padding: 10px;
      border-top: 1px solid #ddd;
      background-color: #f9f9f9;
      border-radius: 5px;
    }

    .file-overview p {
      font-size: 14px;
      margin: 0;
    }

    .add-activity-btn {
      margin-bottom: 20px;
    }

    /* MODAL STYLES */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: black;
    }

    .modal-content input,
    .modal-content textarea {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-family: "Quicksand", sans-serif;
    }

    .modal-content label {
      font-weight: bold;
      font-size: 14px;
    }

    /* File Preview Modal */
  #filePreviewModal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.6);
  }

  #filePreviewModal .modal-content {
    background: white;
    margin: 5% auto;
    border-radius: 10px;
    position: relative;
  }


</style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="profile">
      <img src="fuego.jpg" alt="Profile Image" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-left: 40px;">
      <h3><?php echo htmlspecialchars($teacher_name); ?></h3>
    </div>
    <div class="menu">
      <a href="/CAPSTONE_LMS_EHS/profdashboard/profhome.php">Dashboard</a>
      <a href="/CAPSTONE_LMS_EHS/profdashboard/course .php">Courses</a>
      <a href="/CAPSTONE_LMS_EHS/profdashboard/performance.php">Performance</a>
      <a href="/CAPSTONE_LMS_EHS/profdashboard/reminders.php">Reminders</a>
      <a href="/CAPSTONE_LMS_EHS/profdashboard/account.php">Account</a>
      <a href="/CAPSTONE_LMS_EHS/auth/login.php">Logout</a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main">
    <div class="topbar">
      <a href="/CAPSTONE_LMS_EHS/profdashboard/requirements.php?course=<?= urlencode($course_name) ?>&strand=<?= urlencode($strand) ?>&section=<?= urlencode($section) ?>" class="back-btn">
    <span class="material-icons">arrow_back</span>
</a>

      Activities (<?php echo htmlspecialchars($strand) . " - " . htmlspecialchars($section); ?>)
    </div>

    <!-- Add New Activity Button -->
    <div class="add-activity-btn">
      <button class="btn" onclick="openAddModal()">
        <span class="material-icons">add</span>
        Add New Activity
      </button>
    </div>

    <!-- Sample Activity Card -->
    <!-- Inside Main Content -->

<?php foreach ($activities as $a): ?>
<div class="rewards">
  <div class="menu-dots" onclick="toggleMenu(this)">
    <span class="material-icons">more_vert</span>
    <div class="dropdown-menu">
    <a href="#" onclick="openEditModal(
        <?= $a['activity_id'] ?>,
        '<?= htmlspecialchars($a['title'], ENT_QUOTES) ?>',
        '<?= htmlspecialchars($a['due_date']) ?>',
        '<?= htmlspecialchars($a['due_time']) ?>',
        `<?= htmlspecialchars($a['desc'], ENT_QUOTES) ?>`
    )">Edit</a>
    <a href="?delete_id=<?= $a['activity_id'] ?>" onclick="return confirm('Are you sure you want to delete this activity?');">Delete</a>
    <a href="actlist.php">View Submitted Works</a>
</div>

  </div>
  <h4><?= htmlspecialchars($a['title']) ?></h4>
  <p><strong>Date Posted:</strong> <?= date("F j, Y", strtotime($a['date_posted'])) ?><br>
     <strong>Due Date:</strong> <?= date("F j, Y", strtotime($a['due_date'])) ?></p>
  <p><strong>Description:</strong> <?= nl2br(htmlspecialchars($a['desc'])) ?></p>

  <?php if (!empty($a['file_path'])): ?>
    <div class="file-overview">
        <p><strong>File:</strong>
            <a href="<?= htmlspecialchars($a['file_path']) ?>" target="_blank"><?= htmlspecialchars($a['file_name']) ?></a>
        </p>
    </div>
  <?php else: ?>
    <div class="file-overview">
        <p><strong>File:</strong> No files uploaded yet.</p>
    </div>
  <?php endif; ?>

</div>
<?php endforeach; ?>





        <!-- Add Activity Modal -->
<div class="modal" id="addModal">
    <div class="modal-content">
        <span class="close" onclick="closeAddModal()">&times;</span>
        <h3>Add New Activity</h3>

        <form method="POST" enctype="multipart/form-data">
        <label>Activity Title</label>
        <input type="text" name="title" placeholder="Enter activity title" required>

        <label>Due Date</label>
        <input type="date" name="due_date" required autocomplete="off" min="<?= date('Y-m-d') ?>">

        <label>Due Time</label>
        <input type="time" name="due_time" required>

        <label>Description</label>
        <textarea rows="4" name="desc" placeholder="Enter activity description..." required></textarea>

        <label>Upload File</label>
        <input type="file" name="file" accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.zip,.rar">

        <input type="hidden" name="add_activity" value="1">

        <button class="btn" style="margin-top: 15px;">Save Activity</button>
    </form>

  </div>
</div>

<!-- Edit Activity Modal -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <span class="close" onclick="closeEditModal()">&times;</span>
    <h3>Edit Activity</h3>
    <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="edit_activity_id" id="edit_activity_id">

        <label>Activity Title</label>
        <input type="text" name="edit_title" id="edit_title" required>

        <label>Due Date</label>
        <input type="date" name="edit_due_date" id="edit_due_date" required>

        <label>Due Time</label>
        <input type="time" name="edit_due_time" id="edit_due_time" required>

        <label>Description</label>
        <textarea rows="4" name="edit_desc" id="edit_desc" required></textarea>

        <button class="btn" style="margin-top: 15px;">Save Changes</button>
    </form>
  </div>
</div>



  </div>

  <!-- Scripts -->
  <script>
    function toggleMenu(icon) {
      document.querySelectorAll('.dropdown-menu').forEach(menu => {
        if (menu !== icon.querySelector('.dropdown-menu')) {
          menu.style.display = 'none';
        }
      });
      const menu = icon.querySelector('.dropdown-menu');
      menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    }

    document.addEventListener('click', function (e) {
      if (!e.target.closest('.menu-dots')) {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
          menu.style.display = 'none';
        });
      }
    });

    function openAddModal() {
      document.getElementById("addModal").style.display = "block";
    }

    function closeAddModal() {
      document.getElementById("addModal").style.display = "none";
    }

    window.onclick = function(event) {
      const modal = document.getElementById("addModal");
      if (event.target === modal) {
        modal.style.display = "none";
      }
    }  
    function openEditModal(id, title, dueDate, dueTime, desc) {
    document.getElementById("edit_activity_id").value = id;
    document.getElementById("edit_title").value = title;
    document.getElementById("edit_due_date").value = dueDate;
    document.getElementById("edit_due_time").value = dueTime;
    document.getElementById("edit_desc").value = desc;
    document.getElementById("editModal").style.display = "block";
}

function closeEditModal() {
    document.getElementById("editModal").style.display = "none";
}  
  </script>
</body>
</html>

